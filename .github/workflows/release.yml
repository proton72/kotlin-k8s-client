name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      publish_github:
        description: 'Publish to GitHub Packages'
        required: true
        type: boolean
        default: true
      publish_sonatype:
        description: 'Publish to Sonatype Central'
        required: true
        type: boolean
        default: true

jobs:
  version-and-build:
    name: Update Version and Build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Determine version and release type
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ inputs.version }}"
          IS_PRERELEASE="false"
        else
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        echo "Is prerelease: ${IS_PRERELEASE}"

    - name: Update version in gradle.properties
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        sed -i "s/^version=.*/version=${VERSION}/" gradle.properties
        echo "Updated gradle.properties:"
        cat gradle.properties

    - name: Commit version update
      if: github.event_name == 'release'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add gradle.properties
        git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
        git push origin HEAD:main || git push origin HEAD:master

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.14.3'

    - name: Run tests
      run: gradle test --no-daemon --stacktrace

    - name: Build library
      run: gradle build --no-daemon --stacktrace

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ steps.version.outputs.version }}
        path: |
          build/libs/
          build/publications/
        retention-days: 5

  publish-github-packages:
    name: Publish to GitHub Packages
    needs: version-and-build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release') ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_github)
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set version
      run: |
        sed -i "s/^version=.*/version=${{ needs.version-and-build.outputs.version }}/" gradle.properties

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.14.3'

    - name: Publish to GitHub Packages
      env:
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: gradle publishMavenPublicationToGitHubPackagesRepository --no-daemon --stacktrace

    - name: Report status
      if: always()
      run: |
        if [ ${{ job.status }} = "success" ]; then
          echo "âœ… Successfully published to GitHub Packages"
          echo "ðŸ“¦ Package: https://github.com/${{ github.repository }}/packages"
        else
          echo "âŒ Failed to publish to GitHub Packages"
          exit 1
        fi

  publish-sonatype-central:
    name: Publish to Sonatype Central
    needs: version-and-build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release' && github.event.release.prerelease == false) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_sonatype)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set version
      run: |
        sed -i "s/^version=.*/version=${{ needs.version-and-build.outputs.version }}/" gradle.properties

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.14.3'

    - name: Verify signing configuration
      env:
        GPG_PRIVATE_KEY_BASE64: ${{ secrets.GPG_PRIVATE_KEY_BASE64 }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        if [ -z "$GPG_PRIVATE_KEY_BASE64" ] || [ -z "$GPG_PASSPHRASE" ]; then
          echo "âŒ Missing GPG signing credentials"
          echo "Please configure GPG_PRIVATE_KEY_BASE64 and GPG_PASSPHRASE secrets"
          exit 1
        fi
        echo "âœ… GPG signing credentials configured"

    - name: Verify Sonatype credentials
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      run: |
        if [ -z "$SONATYPE_USERNAME" ] || [ -z "$SONATYPE_PASSWORD" ]; then
          echo "âŒ Missing Sonatype credentials"
          echo "Please configure SONATYPE_USERNAME and SONATYPE_PASSWORD secrets"
          exit 1
        fi
        echo "âœ… Sonatype credentials configured"

    - name: Publish to Sonatype Central
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        GPG_PRIVATE_KEY_BASE64: ${{ secrets.GPG_PRIVATE_KEY_BASE64 }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: gradle publishMavenPublicationToSonatypeCentralRepository --no-daemon --stacktrace

    - name: Report status
      if: always()
      run: |
        if [ ${{ job.status }} = "success" ]; then
          echo "âœ… Successfully published to Sonatype Central"
          echo "ðŸ“¦ Check status: https://central.sonatype.com/publishing"
          echo "ðŸ” Search: https://central.sonatype.com/artifact/io.github.proton72/kotlin-k8s-client"
        else
          echo "âŒ Failed to publish to Sonatype Central"
          exit 1
        fi

  release-summary:
    name: Release Summary
    needs: [version-and-build, publish-github-packages, publish-sonatype-central]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.version-and-build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Prerelease:** ${{ needs.version-and-build.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Publication Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # GitHub Packages status
        if [ "${{ needs.publish-github-packages.result }}" = "success" ]; then
          echo "âœ… **GitHub Packages:** Published successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.publish-github-packages.result }}" = "skipped" ]; then
          echo "â­ï¸ **GitHub Packages:** Skipped" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **GitHub Packages:** Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Sonatype Central status
        if [ "${{ needs.publish-sonatype-central.result }}" = "success" ]; then
          echo "âœ… **Sonatype Central:** Published successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.publish-sonatype-central.result }}" = "skipped" ]; then
          echo "â­ï¸ **Sonatype Central:** Skipped (prereleases only go to GitHub Packages)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Sonatype Central:** Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Links" >> $GITHUB_STEP_SUMMARY
        echo "- [GitHub Packages](https://github.com/${{ github.repository }}/packages)" >> $GITHUB_STEP_SUMMARY
        echo "- [Sonatype Central Portal](https://central.sonatype.com/publishing)" >> $GITHUB_STEP_SUMMARY
        echo "- [Maven Search](https://central.sonatype.com/artifact/io.github.proton72/kotlin-k8s-client)" >> $GITHUB_STEP_SUMMARY
